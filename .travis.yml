language: python
python:
  - "3.4"
  - "3.5"
  - "3.6"
  - "3.7"
compiler:
  - gcc
  
stages:
- test
- name: build-apks
  
cache:
    directories:
     - .buildozer
     - $HOME/.buildozer/

before_install:
  - sudo apt-get update
  - sudo apt-get install -y libgl1-mesa-dev # needed by kivy
  
install:
  - pip install -r requirements.txt
  - pip install coverage codecov
  - pip install -e .
  
script:
  - make test

jobs:
  include:
    - stage: test
      name: coverage with codecov
      if: branch = master AND type != pull_request
      python: "3.7"
      install: 
        - pip install -r requirements.txt
        - pip install coverage codecov
        - pip install -e .
      script: 
        - make coverage
      after_success: codecov
    - stage: build-apk
      name: release
      python: "3.7"
      before_install:
      # most of the following is taken from https://buildozer.readthedocs.io/en/latest/installation.html
        - sudo apt-get update
        - sudo apt-get install -y libgl1-mesa-dev git zip unzip openjdk-8-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake
        - pip install --upgrade cython virtualenv
        - pip install --upgrade buildozer
        - PATH=$PATH:~/.local/bin/
      # temporarily use my p4a fork with workaround, see comment in issue #3
        - git clone -b mapfix-workaround https://github.com/joergbrech/python-for-android.git /home/travis/build/joergbrech/python-for-android
      before_script:
      # workaround to enforce openjdk8 on xenial
      # from https://travis-ci.community/t/oracle-jdk-11-and-10-are-pre-installed-not-the-openjdk-builds/785/3
        - PATH=$(echo "$PATH" | sed -e 's/:\/usr\/local\/lib\/jvm\/openjdk11\/bin//')
        - JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-amd64
      script: 
        - travis_wait 60 make apk-release
      #TODO: Sign, zipalign and upload to Github Releases if tag is present. Maybe even to Play Store
    - stage: build-apk
      name: debug
      python: "3.7"
      before_install:
      # most of the following is taken from https://buildozer.readthedocs.io/en/latest/installation.html
        - sudo apt-get update
        - sudo apt-get install -y libgl1-mesa-dev git zip unzip openjdk-8-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake
        - pip install --upgrade cython virtualenv
        - pip install --upgrade buildozer
        - PATH=$PATH:~/.local/bin/
      # temporarily use my p4a fork with workaround, see comment in issue #3
        - git clone -b mapfix-workaround https://github.com/joergbrech/python-for-android.git /home/travis/build/joergbrech/python-for-android
      before_script:
      # workaround to enforce openjdk8 on xenial
      # from https://travis-ci.community/t/oracle-jdk-11-and-10-are-pre-installed-not-the-openjdk-builds/785/3
        - PATH=$(echo "$PATH" | sed -e 's/:\/usr\/local\/lib\/jvm\/openjdk11\/bin//')
        - JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-amd64
      script: 
        - travis_wait 60 make apk-debug
      #TODO: Sign, zipalign and upload to Github Releases if tag is present.
