language: python
python:
  - "3.4"
  - "3.5"
  - "3.6"
  - "3.7"
compiler:
  - gcc
  
stages:
- test
- name: coverage
  if: branch = master AND type != pull_request
- name: deploy
  if: tag IS present
  
cache:
    directories:
     - $HOME/.buildozer/
     
before_install:
  - sudo apt-get install libgl1-mesa-dev openjdk-8-jdk
  - pip install cython buildozer
  
install:
  - pip install -r requirements.txt
  - pip install -e .
  
before_script:
# workaround to enforce openjdk8 on xenial
# from https://travis-ci.community/t/oracle-jdk-11-and-10-are-pre-installed-not-the-openjdk-builds/785/3
  - PATH=$(echo "$PATH" | sed -e 's/:\/usr\/local\/lib\/jvm\/openjdk11\/bin//')
  - JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-amd64
  - java -version
  
script:
  - make test
  - travis_wait 60 make apk

jobs:
  include:
    - stage: coverage
      python: "3.6"
      install: 
        - pip install -r requirements.txt
        - pip install coverage codecov
        - pip install -e .
      script: 
        - make coverage
      after_success: codecov
    - stage: deploy
      python: "3.6"
      script: 
        - make deploy
      #TODO: Upload to Github Releases and maybe even Play Store
